<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>10 Baseball â€“ æ™®é€šã®é‡çƒÃ—è¶³ã—ç®—</title>
<meta name="theme-color" content="#F4F1EA">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --bg:#F4F1EA; --paper:#FFFFFF; --ink:#131313; --muted:#6D7280; --line:#E5DED2; --chip:#FBF8F2;
    --accent:#1554F6; --good:#11a36f; --warn:#e24e52;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--ink);
    background:radial-gradient(1200px 600px at 50% -10%,#FFF,#F4F1EA 55%);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Helvetica Neue","Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
  }
  #wrap{min-height:100%;display:flex;flex-direction:column}
  header{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--line)}
  .brand{display:flex;align-items:baseline;gap:10px}
  .ttl{font-weight:800;letter-spacing:.02em}
  .sub{color:var(--muted);font-size:12px;letter-spacing:.04em}
  .chips{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--line);padding:8px 10px;border-radius:12px;font-weight:700}

  #stage{flex:1;display:flex;align-items:center;justify-content:center;padding:14px}
  canvas{touch-action:none;background:var(--paper);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.06)}

  footer{padding:10px 14px;border-top:1px solid var(--line);color:var(--muted);font-size:14px;text-align:center}

  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
    background:#111;color:#fff;border-radius:10px;padding:10px 14px;opacity:0;transition:.25s;pointer-events:none}
  .toast.show{opacity:1}

  /* å³ã‚µã‚¤ãƒ‰ã®æ•°å­—ãƒ‘ãƒƒãƒ‰ï¼ˆã‚¹ã‚¤ãƒ³ã‚°ï¼‰ */
  #pad{
    position:fixed; right:12px; top:50%; transform:translateY(-50%);
    display:grid; grid-template-columns:repeat(3,64px); gap:10px;
    z-index:9999;
  }
  .num{
    width:64px;height:64px;border-radius:999px;border:1px solid var(--line);
    background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.08);
    font-weight:900; font-size:20px; letter-spacing:.04em;
    display:grid; place-items:center; cursor:pointer;
  }
  .num:active{transform:scale(.98)}
  @media (max-width: 520px){
    #pad{grid-template-columns:repeat(3,56px)}
    .num{width:56px;height:56px}
  }

  /* Help modal */
  #help{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;padding:18px}
  #help[open]{display:flex}
  #help .card{width:min(560px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}
  #help h3{margin:.2em 0 .6em;font-size:18px}
  #help ol{padding-left:1.1em;line-height:1.6}
  #help li{margin:.35em 0}
  #help .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .btn{border:1px solid var(--line);padding:8px 12px;border-radius:12px;background:#fff;font-weight:700}
  .btn.strong{border-color:transparent;background:#111;color:#fff}
  .btn.ghost{background:#fff}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="brand">
      <div class="ttl">10 Baseball</div>
      <div class="sub">æ™®é€šã®é‡çƒ Ã— è¶³ã—ç®—ï¼ˆ10ã«ã—ã‚ˆã†ï¼ï¼‰</div>
    </div>
    <div class="chips">
      <div class="chip">Inning: <b id="inning">1</b></div>
      <div class="chip">B: <b id="balls">0</b> / S: <b id="strikes">0</b> / O: <b id="outs">0</b></div>
      <div class="chip">Runs: <b id="runs">0</b></div>
      <div class="chip">Score: <b id="score">0</b> / Best: <b id="best">0</b></div>
      <button class="btn ghost" id="helpBtn" aria-haspopup="dialog" aria-controls="help">éŠã³æ–¹</button>
      <button class="btn strong" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </header>

  <div id="stage">
    <canvas id="cv" width="360" height="640" aria-label="10 Baseball canvas"></canvas>
  </div>

  <footer>
    ãƒ”ãƒƒãƒãƒ£ãƒ¼ãŒ<b>æ•°å­—ãƒœãƒ¼ãƒ«ï¼ˆ1ã€œ9ï¼‰</b>ã‚’æŠ•ã’ã¾ã™ã€‚<br>
    å³ã®<b>æ•°å­—ãƒ‘ãƒƒãƒ‰</b>ï¼ˆã¾ãŸã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰<b>1ã€œ9</b>ï¼‰ã§<b>ã‚¹ã‚¤ãƒ³ã‚°</b>ï¼<br>
    æŠ¼ã—ãŸæ•°å­—ï¼‹ãƒœãƒ¼ãƒ«ã®æ•°å­—ãŒ<b>10</b>ã§<b>å½“ãŸã‚Š</b>ã€‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§<b>å˜æ‰“/äºŒå¡æ‰“/HR</b>ã«ï¼<br>
    è¦‹é€ƒã—ã¯<b>ãƒœãƒ¼ãƒ« or ã‚¹ãƒˆãƒ©ã‚¤ã‚¯</b>ã€‚<b>4ãƒœãƒ¼ãƒ«</b>ã§å››çƒã€<b>3ã‚¹ãƒˆãƒ©ã‚¤ã‚¯</b>ã§ä¸‰æŒ¯ã‚¢ã‚¦ãƒˆã€‚
  </footer>
</div>

<!-- å³ã‚µã‚¤ãƒ‰æ•°å­—ãƒ‘ãƒƒãƒ‰ -->
<div id="pad" aria-label="ã‚¹ã‚¤ãƒ³ã‚°ç”¨æ•°å­—ãƒ‘ãƒƒãƒ‰">
  <button class="num" data-n="7">7</button>
  <button class="num" data-n="8">8</button>
  <button class="num" data-n="9">9</button>
  <button class="num" data-n="4">4</button>
  <button class="num" data-n="5">5</button>
  <button class="num" data-n="6">6</button>
  <button class="num" data-n="1">1</button>
  <button class="num" data-n="2">2</button>
  <button class="num" data-n="3">3</button>
</div>

<!-- How-to -->
<div id="help" role="dialog" aria-modal="true" aria-label="éŠã³æ–¹">
  <div class="card">
    <h3>ğŸ® éŠã³æ–¹ï¼ˆ10 Baseballï¼‰</h3>
    <ol>
      <li>ãƒœãƒ¼ãƒ«ï¼ˆ1ã€œ9ï¼‰ãŒ<b>ãƒ”ãƒƒãƒãƒ£ãƒ¼</b>ã‹ã‚‰<b>ãƒ›ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹</b>ã¸é£›ã‚“ã§ãã¾ã™ã€‚</li>
      <li>å³ã®<b>æ•°å­—ãƒ‘ãƒƒãƒ‰</b>ã‹<b>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰1ã€œ9</b>ã§<b>ã‚¹ã‚¤ãƒ³ã‚°</b>ã—ã¾ã™ã€‚</li>
      <li><b>ãƒœãƒ¼ãƒ«ã®æ•°ï¼‹æŠ¼ã—ãŸæ•°ï¼10</b>ãªã‚‰<b>æ‰“çƒ</b>ï¼ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§<b>ã‚·ãƒ³ã‚°ãƒ«/ãƒ„ãƒ¼ãƒ™ãƒ¼ã‚¹/ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³</b>ã€‚</li>
      <li>åˆã‚ãªã„/ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ‚ªã„ â†’ <b>ç©ºæŒ¯ã‚Š</b>ï¼ˆã‚¹ãƒˆãƒ©ã‚¤ã‚¯ï¼‰ã€‚è¦‹é€ƒã—ã¯<b>ãƒœãƒ¼ãƒ«/ã‚¹ãƒˆãƒ©ã‚¤ã‚¯</b>ã‚’è‡ªå‹•åˆ¤å®šã€‚</li>
      <li><b>4ãƒœãƒ¼ãƒ«</b>ã§å››çƒé€²å¡ã€<b>3ã‚¹ãƒˆãƒ©ã‚¤ã‚¯</b>ã§ä¸‰æŒ¯ã€‚ãƒ©ãƒ³ãƒŠãƒ¼/å¾—ç‚¹/ã‚¤ãƒ‹ãƒ³ã‚°ã¯æœ¬ç‰©ã®é‡çƒãƒ«ãƒ¼ãƒ«ã€‚</li>
    </ol>
    <div class="actions">
      <button class="btn ghost" id="closeHelp">é–‰ã˜ã‚‹</button>
      <button class="btn strong" id="okHelp">OK</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(()=> {
  // ===== DOM =====
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const inningEl = document.getElementById('inning');
  const ballsEl  = document.getElementById('balls');
  const strikesEl= document.getElementById('strikes');
  const outsEl   = document.getElementById('outs');
  const runsEl   = document.getElementById('runs');
  const scoreEl  = document.getElementById('score');
  const bestEl   = document.getElementById('best');
  const resetBtn = document.getElementById('resetBtn');
  const helpBtn  = document.getElementById('helpBtn');
  const helpModal= document.getElementById('help');
  const closeHelp= document.getElementById('closeHelp');
  const okHelp   = document.getElementById('okHelp');
  const pad      = document.getElementById('pad');
  const toastEl  = document.getElementById('toast');

  // ===== layout fit =====
  function fit(){
    const maxW = Math.min(innerWidth - 24, 440);
    const ratio = maxW / cv.width;
    cv.style.width = maxW+'px';
    cv.style.height = (cv.height*ratio)+'px';
  }
  addEventListener('resize', fit); fit();

  // ===== world & ui =====
  const W = cv.width, H = cv.height;
  const LEFT = 18, RIGHT = W-18, FLOOR = H-14, CEIL = 70;
  const PLATE_X = W/2, PLATE_Y = H-120;
  const STRIKE_W = 90, STRIKE_H = 120;  // ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³

  // çŠ¶æ…‹
  let inning=1, balls=0, strikes=0, outs=0, runs=0, score=0;
  let bases = { first:false, second:false, third:false };

  // ãƒ”ãƒƒãƒ
  let pitch=null; // {x,y,vx,vy, num, inZone, alive, tToPlate}
  let nextPitchTimer = 0.6; // æ¬¡ã®æŠ•çƒã¾ã§

  // ãƒãƒƒãƒˆæ¼”å‡º
  const BAT = { r:18, arc:{start:-0.6,end:0.4}, swingT:0, DUR:0.16, cd:0, COOLDOWN:0.18 };

  // ===== helpers =====
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function toast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 1200); }
  function updateHUD(){
    inningEl.textContent=inning; ballsEl.textContent=balls; strikesEl.textContent=strikes; outsEl.textContent=outs;
    runsEl.textContent=runs; scoreEl.textContent=score;
    const best = +(localStorage.getItem('tenbase_best')||0);
    if (score>best) localStorage.setItem('tenbase_best', score|0);
    bestEl.textContent = localStorage.getItem('tenbase_best')||0;
  }
  function resetGame(){
    inning=1; balls=0; strikes=0; outs=0; runs=0; score=0;
    bases.first=bases.second=bases.third=false;
    pitch=null; nextPitchTimer=0.6;
    updateHUD();
  }

  // ===== baseball logic =====
  function walkAdvance(){
    // å››çƒï¼šä¸€å¡ãŒç©ºãªã‚‰æ‰“è€…ãŒä¸€å¡ã€åŸ‹ã¾ã£ã¦ã„ã‚Œã°æŠ¼ã—å‡ºã—
    if (bases.first && bases.second && bases.third) { runs++; toast('æŠ¼ã—å‡ºã—ï¼'); }
    const newThird = (bases.second && bases.first) ? true : bases.third;
    const newSecond= bases.first ? true : bases.second;
    const newFirst = true;
    bases.first=newFirst; bases.second=newSecond; bases.third=newThird;
  }

  function single(){
    if (bases.third) { runs++; }
    const newThird = bases.second;
    const newSecond= bases.first;
    const newFirst = true;
    bases.first=newFirst; bases.second=newSecond; bases.third=newThird;
    score += 10; balls=0; strikes=0;
  }
  function doubleHit(){
    let add=0; if (bases.third) add++; if (bases.second) add++;
    runs += add;
    const newThird = bases.first;
    bases.first=false; bases.second=true; bases.third=newThird;
    score += 20; balls=0; strikes=0;
  }
  function homerun(){
    let add = 1 + (bases.first?1:0) + (bases.second?1:0) + (bases.third?1:0);
    runs += add; bases.first=bases.second=bases.third=false;
    score += 50; balls=0; strikes=0;
  }
  function out(){
    strikes=0; balls=0; outs++;
    if (outs>=3){
      outs=0; inning++; bases.first=bases.second=bases.third=false;
      toast('3ã‚¢ã‚¦ãƒˆäº¤ä»£ï¼ Inning '+inning);
    }else{
      toast('ã‚¢ã‚¦ãƒˆï¼ ('+outs+'ã‚¢ã‚¦ãƒˆ)');
    }
  }

  // ===== pitch engine =====
  function spawnPitch(){
    const num = 1 + (Math.random()*9|0);
    const inZone = Math.random()<0.68; // ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ç‡
    const startX = PLATE_X + (Math.random()*120 - 60);
    const startY = CEIL+4;
    const timeToPlate = 1.05 + Math.random()*0.35;
    const targetX = inZone
      ? PLATE_X + (Math.random()* (STRIKE_W*0.4) - STRIKE_W*0.2)
      : PLATE_X + (Math.random()<0.5 ? -1 : 1) * (STRIKE_W*0.8 + Math.random()*60);
    const targetY = PLATE_Y;
    const vx = (targetX - startX)/timeToPlate;
    const vy = (targetY - startY)/timeToPlate;
    pitch = {x:startX, y:startY, vx, vy, num, inZone, alive:true, tToPlate:timeToPlate};
  }

  function endPitch(){
    pitch = null;
    nextPitchTimer = 0.9 + Math.random()*0.7;
    BAT.swingT = 0; // ã‚¢ãƒ‹ãƒ¡çµ‚äº†
  }

  // ===== swing (number) =====
  function timingGrade(dist){
    // dist(px) from plateY atæŠ¼ä¸‹æ™‚
    if (dist<=6) return 'perfect';
    if (dist<=16) return 'good';
    if (dist<=28) return 'fair';
    return 'miss';
  }
  function swingWith(n){
    // ãƒãƒƒãƒˆæ¼”å‡º
    if (BAT.cd<=0){ BAT.swingT = BAT.DUR; BAT.cd = BAT.COOLDOWN; }
    if (!pitch || !pitch.alive) return;

    const d = Math.abs(pitch.y - PLATE_Y);
    const grade = timingGrade(d);
    const sum = n + pitch.num;
    if (grade==='miss'){
      // æ—©ã™ã/é…ã™ã â†’ ç©ºæŒ¯ã‚Š
      strikes++; toast('ç©ºæŒ¯ã‚Šâ€¦');
      if (strikes>=3){ out(); }
      endPitch(); updateHUD(); return;
    }

    if (sum===10){
      // å½“ãŸã‚Šï¼ è§’åº¦ãƒ»é£›è·é›¢ç›¸å½“ã‚’ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§
      if (grade==='perfect'){ homerun(); toast('ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ï¼'); }
      else if (grade==='good'){ doubleHit(); toast('ãƒ„ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼'); }
      else { single(); toast('ãƒ’ãƒƒãƒˆï¼'); }
      endPitch(); updateHUD(); return;
    }

    // 10ã‹ã‚‰Â±1ã§ã‚¿ã‚¤ãƒŸãƒ³ã‚°è‰¯ â†’ ãƒ•ã‚¡ã‚¦ãƒ«ï¼ˆ2ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ä»¥é™ã¯å¢—ãˆãªã„ï¼‰
    if (Math.abs(10 - sum)===1 && (grade==='perfect' || grade==='good' || grade==='fair')){
      if (strikes<2){ strikes++; }
      toast('ãƒ•ã‚¡ã‚¦ãƒ«');
      endPitch(); updateHUD(); return;
    }

    // å¤–ã— â†’ ç©ºæŒ¯ã‚Š
    strikes++; toast('ç©ºæŒ¯ã‚Šâ€¦');
    if (strikes>=3){ out(); }
    endPitch(); updateHUD();
  }

  // ===== input wiring =====
  pad.addEventListener('click', (e)=>{
    const b = e.target.closest('.num');
    if (!b) return;
    const n = +(b.dataset.n||0); if (!n) return;
    swingWith(n);
  });
  addEventListener('keydown', (e)=>{
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ 1..9
    const k = e.key;
    if (k>='1' && k<='9'){ swingWith(+k); }
  });

  // ===== help =====
  function openHelp(){ helpModal.setAttribute('open',''); }
  function closeHelpModal(){ helpModal.removeAttribute('open'); }
  helpBtn.addEventListener('click', openHelp);
  closeHelp.addEventListener('click', closeHelpModal);
  okHelp.addEventListener('click', closeHelpModal);
  helpModal.addEventListener('click', (e)=>{ if (e.target===helpModal) closeHelpModal(); });
  if (!localStorage.getItem('tenbase_seen_help')){ openHelp(); localStorage.setItem('tenbase_seen_help','1'); }

  // ===== reset =====
  resetBtn.addEventListener('click', ()=>{ resetGame(); toast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ'); });

  // ===== draw =====
  function drawBall(x,y,r,num){
    // é‡çƒãƒœãƒ¼ãƒ«é¢¨
    ctx.save(); ctx.translate(x,y);
    const g = ctx.createRadialGradient(-r*0.4,-r*0.6, r*0.2, 0,0, r);
    g.addColorStop(0,'#fff'); g.addColorStop(1,'#ececec');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.08)'; ctx.lineWidth=2; ctx.stroke();

    // ç¸«ã„ç›®
    ctx.strokeStyle='#d33'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,0,r*0.72, -1.1, 1.1); ctx.stroke();
    ctx.beginPath(); ctx.arc(0,0,r*0.72, Math.PI-1.1, Math.PI+1.1); ctx.stroke();
    // ã‚¹ãƒ†ãƒƒãƒ
    function stitches(a0,a1){
      const n=6;
      for(let i=0;i<=n;i++){
        const t=i/n, ang=a0+(a1-a0)*t;
        const px=Math.cos(ang)*r*0.72, py=Math.sin(ang)*r*0.72;
        const nx=-Math.sin(ang), ny=Math.cos(ang);
        ctx.beginPath(); ctx.moveTo(px-nx*4, py-ny*4); ctx.lineTo(px+nx*4, py+ny*4); ctx.stroke();
      }
    }
    stitches(-1.1,1.1); stitches(Math.PI-1.1, Math.PI+1.1);

    // æ•°å­—
    ctx.fillStyle='#111'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font='bold '+Math.floor(r*1.1)+'px system-ui'; ctx.fillText(num, 0, 2);
    ctx.restore();
  }

  function drawDiamondHUD(){
    // å·¦ä¸Šï¼šãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ï¼ˆå æœ‰è¡¨ç¤ºï¼‰
    const x = 30, y = 28, a = 8;
    function base(px,py,filled){
      ctx.save(); ctx.translate(px,py); ctx.rotate(Math.PI/4);
      ctx.fillStyle = filled ? 'rgba(17,163,111,0.9)' : 'rgba(0,0,0,0.08)';
      ctx.strokeStyle='rgba(0,0,0,0.18)'; ctx.lineWidth=1.3;
      ctx.beginPath(); ctx.rect(-a,-a,a*2,a*2); ctx.fill(); ctx.stroke();
      ctx.restore();
    }
    base(x, y, bases.second);
    base(x-18, y+18, bases.first);
    base(x+18, y+18, bases.third);
    // ãƒ›ãƒ¼ãƒ 
    ctx.save(); ctx.translate(x, y+36); ctx.rotate(Math.PI/4);
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.beginPath(); ctx.rect(-a,-a,a*2,a*2); ctx.fill();
    ctx.restore();
  }

  function drawBat(){
    // ä¸­å¤®å›ºå®šã®ãƒãƒƒãƒˆãƒ˜ãƒƒãƒ‰å††
    const R = 68;
    // ã‚¬ã‚¤ãƒ‰å¼§
    ctx.strokeStyle='rgba(0,0,0,.08)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(PLATE_X, PLATE_Y, R, -0.6, 0.4); ctx.stroke();
    // ãƒ˜ãƒƒãƒ‰
    const t = BAT.DUR>0 ? clamp(1 - BAT.swingT/BAT.DUR, 0, 1) : 0;
    const k = 1 - Math.pow(1-t, 2);
    const ang = -0.6 + (0.4+0.6)*k;
    const x = PLATE_X + Math.cos(ang)*R, y = PLATE_Y + Math.sin(ang)*R;
    ctx.globalAlpha = BAT.swingT>0 ? 0.95 : 0.55;
    ctx.fillStyle='rgba(20,20,20,.20)';
    ctx.beginPath(); ctx.arc(x,y, BAT.r, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha=1;
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    // å¤–æ 
    ctx.strokeStyle = 'rgba(0,0,0,.12)'; ctx.lineWidth = 2;
    roundRectPath(LEFT-8, 6, RIGHT-LEFT+16, FLOOR-6, 16); ctx.stroke();

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰èƒŒæ™¯ï¼ˆèŠã£ã½ãï¼‰
    ctx.fillStyle='#f9f7f2';
    ctx.fillRect(LEFT, CEIL, RIGHT-LEFT, FLOOR-CEIL);

    // ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ã‚¾ãƒ¼ãƒ³
    ctx.save();
    ctx.strokeStyle='rgba(21,84,246,.28)'; ctx.lineWidth=2;
    ctx.strokeRect(PLATE_X-STRIKE_W/2, PLATE_Y-STRIKE_H, STRIKE_W, STRIKE_H);
    ctx.restore();

    // ç›®æ¨™ãƒ’ãƒ³ãƒˆï¼ˆã­ã‚‰ã„=10-æŠ•çƒæ•°å­—ï¼‰
    if (pitch){
      ctx.fillStyle='rgba(0,0,0,.55)'; ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.font='bold 14px system-ui';
      ctx.fillText('ã­ã‚‰ã„ï¼š '+(10 - pitch.num), PLATE_X, PLATE_Y + 74);
    }

    // ãƒœãƒ¼ãƒ«
    if (pitch){
      drawBall(pitch.x, pitch.y, 18, pitch.num);
    }

    // ãƒ›ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹ï¼ˆé£¾ã‚Šï¼‰
    ctx.fillStyle='#eee';
    ctx.beginPath();
    ctx.moveTo(PLATE_X-16, PLATE_Y+16);
    ctx.lineTo(PLATE_X+16, PLATE_Y+16);
    ctx.lineTo(PLATE_X+16, PLATE_Y);
    ctx.lineTo(PLATE_X, PLATE_Y-16);
    ctx.lineTo(PLATE_X-16, PLATE_Y);
    ctx.closePath(); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,.08)'; ctx.stroke();

    // ãƒãƒƒãƒˆ
    drawBat();

    // ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰HUD
    drawDiamondHUD();
  }

  function roundRectPath(x,y,w,h,r){
    ctx.beginPath(); ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
  }

  // ===== main loop =====
  let last = performance.now();
  function loop(now){
    const dt = (now-last)/1000; last=now;

    // ãƒãƒƒãƒˆCD
    if (BAT.swingT>0) BAT.swingT = Math.max(0, BAT.swingT - dt);
    if (BAT.cd>0)     BAT.cd     = Math.max(0, BAT.cd - dt);

    // æŠ•çƒç®¡ç†
    if (!pitch){
      nextPitchTimer -= dt;
      if (nextPitchTimer<=0) spawnPitch();
    }else{
      // é€²è¡Œ
      pitch.tToPlate = Math.max(0, pitch.tToPlate - dt);
      pitch.x += pitch.vx*dt;
      pitch.y += pitch.vy*dt;

      // ãƒ—ãƒ¬ãƒ¼ãƒˆé€šéå¾Œã®è‡ªå‹•åˆ¤å®š
      if (pitch.y >= PLATE_Y + 24){
        if (pitch.inZone){
          strikes++; toast('è¦‹é€ƒã—ã‚¹ãƒˆãƒ©ã‚¤ã‚¯');
          if (strikes>=3){ out(); }
        }else{
          balls++; toast('ãƒœãƒ¼ãƒ«');
          if (balls>=4){ walkAdvance(); balls=0; strikes=0; toast('ãƒ•ã‚©ã‚¢ãƒœãƒ¼ãƒ«'); }
        }
        endPitch(); updateHUD();
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  // init
  resetGame(); updateHUD(); requestAnimationFrame(loop);

})();
</script>

<!-- Service Workerï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œãƒ»å‹•çš„ç”Ÿæˆï¼‰ -->
<script>
if ('serviceWorker' in navigator) {
  const code = `
    const CACHE='10baseball-normal-v1';
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('activate',e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE&&caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch',e=>{
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
    });
  `;
  const blob = new Blob([code], {type:'application/javascript'});
  const url = URL.createObjectURL(blob);
  addEventListener('load', () => navigator.serviceWorker.register(url));
}
</script>
</body>
</html>
