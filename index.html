<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>10 Baseball – 普通の野球×足し算（強化版）</title>
<meta name="theme-color" content="#F4F1EA">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#F4F1EA; --paper:#FFFFFF; --ink:#131313; --muted:#6D7280; --line:#E5DED2; --chip:#FBF8F2;
    --accent:#1554F6; --good:#11a36f; --warn:#e24e52;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--ink);
    background:radial-gradient(1200px 600px at 50% -10%,#FFF,#F4F1EA 55%);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Helvetica Neue","Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
  }
  #wrap{min-height:100%;display:flex;flex-direction:column}
  header{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--line)}
  .brand{display:flex;align-items:baseline;gap:10px}
  .ttl{font-weight:800;letter-spacing:.02em}
  .sub{color:var(--muted);font-size:12px;letter-spacing:.04em}
  .chips{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--line);padding:8px 10px;border-radius:12px;font-weight:700}
  .btn{border:1px solid var(--line);padding:8px 12px;border-radius:12px;background:#fff;font-weight:700}
  .btn.strong{border-color:transparent;background:#111;color:#fff}
  .btn.ghost{background:#fff}

  #stage{flex:1;display:flex;align-items:center;justify-content:center;padding:14px}
  canvas{touch-action:none;background:var(--paper);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.06)}
  footer{padding:10px 14px;border-top:1px solid var(--line);color:var(--muted);font-size:14px;text-align:center}

  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
    background:#111;color:#fff;border-radius:10px;padding:10px 14px;opacity:0;transition:.25s;pointer-events:none}
  .toast.show{opacity:1}

  /* 右サイドの数字パッド（スイング） */
  #pad{
    position:fixed; right:12px; top:50%; transform:translateY(-50%);
    display:grid; grid-template-columns:repeat(3,64px); gap:10px;
    z-index:9999;
  }
  .num{
    width:64px;height:64px;border-radius:999px;border:1px solid var(--line);
    background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.08);
    font-weight:900; font-size:20px; letter-spacing:.04em;
    display:grid; place-items:center; cursor:pointer;
  }
  .num:active{transform:scale(.98)}
  @media (max-width: 520px){
    #pad{grid-template-columns:repeat(3,56px)}
    .num{width:56px;height:56px}
  }

  /* Help modal */
  #help{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;padding:18px}
  #help[open]{display:flex}
  #help .card{width:min(560px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}
  #help h3{margin:.2em 0 .6em;font-size:18px}
  #help ol{padding-left:1.1em;line-height:1.6}
  #help li{margin:.35em 0}
  #help .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="brand">
      <div class="ttl">10 Baseball</div>
      <div class="sub">普通の野球 × 足し算（10でスイング！）</div>
    </div>
    <div class="chips">
      <div class="chip">Inning: <b id="inning">1</b></div>
      <div class="chip">B: <b id="balls">0</b> / S: <b id="strikes">0</b> / O: <b id="outs">0</b></div>
      <div class="chip">Runs: <b id="runs">0</b></div>
      <div class="chip">Score: <b id="score">0</b> / Best: <b id="best">0</b></div>
      <button class="btn ghost" id="helpBtn" aria-haspopup="dialog" aria-controls="help">遊び方</button>
      <button class="btn strong" id="resetBtn">リセット</button>
    </div>
  </header>

  <div id="stage">
    <canvas id="cv" width="360" height="640" aria-label="10 Baseball canvas"></canvas>
  </div>

  <footer>
    ピッチャーが<b>数字ボール（1〜9）</b>を投げます。右の<b>数字パッド</b>（またはキーボード<b>1〜9</b>）で<b>スイング</b>！<br>
    押した数＋ボールの数が<b>10</b>でヒット。タイミングと当たりで<b>内野ゴロ/ヒット/2塁打/3塁打/HR</b>の演出が変わります。<br>
    ストレートのストライクを増量。バットの弧と半径を調整し、球との距離感を改善しました。
  </footer>
</div>

<!-- 右サイド数字パッド -->
<div id="pad" aria-label="スイング用数字パッド">
  <button class="num" data-n="7">7</button>
  <button class="num" data-n="8">8</button>
  <button class="num" data-n="9">9</button>
  <button class="num" data-n="4">4</button>
  <button class="num" data-n="5">5</button>
  <button class="num" data-n="6">6</button>
  <button class="num" data-n="1">1</button>
  <button class="num" data-n="2">2</button>
  <button class="num" data-n="3">3</button>
</div>

<!-- How-to -->
<div id="help" role="dialog" aria-modal="true" aria-label="遊び方">
  <div class="card">
    <h3>🎮 遊び方（10 Baseball）</h3>
    <ol>
      <li>ボール（1〜9）が<b>ピッチャー</b>から<b>ホームベース</b>へ飛んできます。</li>
      <li>右の<b>数字パッド</b>か<b>キーボード1〜9</b>で<b>スイング</b>します。</li>
      <li><b>ボールの数＋押した数＝10</b>かつ、バットとボールが接触すると<b>打球</b>に！</li>
      <li>当たり具合で<b>内野ゴロ/ヒット/2塁打/3塁打/ホームラン</b>を演出し、走者/得点を反映します。</li>
      <li>見逃しは<b>ボール or ストライク</b>。<b>4ボール</b>で四球、<b>3ストライク</b>で三振。</li>
    </ol>
    <div class="actions">
      <button class="btn ghost" id="closeHelp">閉じる</button>
      <button class="btn strong" id="okHelp">OK</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(()=> {
  // ===== DOM =====
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const inningEl = document.getElementById('inning');
  const ballsEl  = document.getElementById('balls');
  const strikesEl= document.getElementById('strikes');
  const outsEl   = document.getElementById('outs');
  const runsEl   = document.getElementById('runs');
  const scoreEl  = document.getElementById('score');
  const bestEl   = document.getElementById('best');
  const resetBtn = document.getElementById('resetBtn');
  const helpBtn  = document.getElementById('helpBtn');
  const helpModal= document.getElementById('help');
  const closeHelp= document.getElementById('closeHelp');
  const okHelp   = document.getElementById('okHelp');
  const pad      = document.getElementById('pad');
  const toastEl  = document.getElementById('toast');

  // ===== layout fit =====
  function fit(){
    const maxW = Math.min(innerWidth - 24, 440);
    const ratio = maxW / cv.width;
    cv.style.width = maxW+'px';
    cv.style.height = (cv.height*ratio)+'px';
  }
  addEventListener('resize', fit); fit();

  // ===== world =====
  const W = cv.width, H = cv.height;
  const LEFT = 18, RIGHT = W-18, FLOOR = H-14, CEIL = 70;
  const PLATE_X = W/2, PLATE_Y = H-120;
  const STRIKE_W = 86, STRIKE_H = 122;  // 少し調整

  // バット（視覚＋当たり）：カプセル
  const BAT = {
    cx: PLATE_X,
    cy: PLATE_Y + 8,      // 少し下げて距離感を確保
    R: 90,                // 弧半径（以前より大きくして“離す”）
    start: -1.0,          // スタート角（後ろ）
    end: 0.15,            // 終端角（前）
    t: 0, DUR: 0.16,      // スイング時間
    cd: 0, COOLDOWN: 0.18,
    headR: 15,            // 先端太さ
    shaftR: 8,            // グリップ太さ
    len: 110,             // バットの見た目長
    activeDigit: 0,       // 押した数字（スイング中のみ有効）
    hitLock: false        // 同一投球での多重ヒット防止
  };

  // スコア・ランナー
  let inning=1, balls=0, strikes=0, outs=0, runs=0, score=0;
  let bases = { first:false, second:false, third:false };

  // ピッチ（現行）と飛球（演出）
  let pitch=null; // {x,y,vx,vy,num,inZone,alive}
  let fly=null;   // {x,y,vx,vy,ax,ay,type,t,trail:[]}
  let nextPitchTimer = 0.5;

  // ===== helpers =====
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function toast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 1200); }
  function updateHUD(){
    inningEl.textContent=inning; ballsEl.textContent=balls; strikesEl.textContent=strikes; outsEl.textContent=outs;
    runsEl.textContent=runs; scoreEl.textContent=score;
    const best = +(localStorage.getItem('tenbase_best_v2')||0);
    if (score>best) localStorage.setItem('tenbase_best_v2', score|0);
    bestEl.textContent = localStorage.getItem('tenbase_best_v2')||0;
  }
  function resetGame(){
    inning=1; balls=0; strikes=0; outs=0; runs=0; score=0;
    bases.first=bases.second=bases.third=false;
    pitch=null; fly=null; nextPitchTimer=0.6;
    BAT.t=0; BAT.cd=0; BAT.activeDigit=0; BAT.hitLock=false;
    updateHUD();
  }

  // ===== 野球ルール適用 =====
  function walkAdvance(){
    if (bases.first && bases.second && bases.third) { runs++; toast('押し出し！'); }
    const newThird = (bases.second && bases.first) ? true : bases.third;
    const newSecond= bases.first ? true : bases.second;
    bases.first=true; bases.second=newSecond; bases.third=newThird;
  }
  function single(){
    if (bases.third) runs++;
    const newThird = bases.second;
    const newSecond= bases.first;
    bases.first=true; bases.second=newSecond; bases.third=newThird;
    score += 10; balls=0; strikes=0;
  }
  function doubleHit(){
    let add=0; if (bases.third) add++; if (bases.second) add++;
    runs += add;
    const newThird = bases.first;
    bases.first=false; bases.second=true; bases.third=newThird;
    score += 20; balls=0; strikes=0;
  }
  function tripleHit(){
    let add=0; if (bases.third) add++; if (bases.second) add++; if (bases.first) add++;
    runs += add;
    bases.first=false; bases.second=false; bases.third=true;
    score += 35; balls=0; strikes=0;
  }
  function homerun(){
    let add = 1 + (bases.first?1:0) + (bases.second?1:0) + (bases.third?1:0);
    runs += add; bases.first=bases.second=bases.third=false;
    score += 60; balls=0; strikes=0;
  }
  function out(){
    strikes=0; balls=0; outs++;
    if (outs>=3){
      outs=0; inning++; bases.first=bases.second=bases.third=false;
      toast('3アウト交代！ Inning '+inning);
    }else{
      toast('アウト！ ('+outs+'アウト)');
    }
  }

  // ===== ピッチ生成（ストレート増） =====
  function spawnPitch(){
    const num = 1 + (Math.random()*9|0);
    const inZone = Math.random()<0.82; // ★ ストライク率を高める
    const straight = inZone && Math.random()<0.75; // ★ まっすぐ中心
    const startX = PLATE_X + (straight ? (Math.random()*20-10) : (Math.random()*120 - 60));
    const startY = CEIL+6;
    const timeToPlate = 0.95 + Math.random()*0.28;
    const targetX = inZone
      ? (straight ? PLATE_X : PLATE_X + (Math.random()* (STRIKE_W*0.35) - STRIKE_W*0.175))
      : PLATE_X + (Math.random()<0.5 ? -1 : 1) * (STRIKE_W*0.9 + Math.random()*70);
    const targetY = PLATE_Y - 6;
    const vx = (targetX - startX)/timeToPlate;
    const vy = (targetY - startY)/timeToPlate;
    pitch = {x:startX, y:startY, vx, vy, num, inZone, alive:true};
    BAT.hitLock=false; // 次の球で解放
    BAT.activeDigit=0;
  }

  function endPitch(autoJudge=true){
    if (autoJudge && pitch){
      // 見逃し判定
      if (pitch.inZone){
        strikes++; toast('見逃しストライク');
        if (strikes>=3){ out(); }
      }else{
        balls++; toast('ボール');
        if (balls>=4){ walkAdvance(); balls=0; strikes=0; toast('フォアボール'); }
      }
    }
    pitch = null;
    nextPitchTimer = 0.85 + Math.random()*0.6;
    BAT.t=0; BAT.activeDigit=0;
  }

  // ===== バット形状（カプセル）・姿勢 =====
  function batAngle(){
    const t = BAT.DUR>0 ? clamp(1 - BAT.t/BAT.DUR, 0, 1) : 0;
    const k = 1 - Math.pow(1-t, 2); // ease-out
    return BAT.start + (BAT.end - BAT.start)*k;
  }
  function batSegment(){
    // グリップ→先端の線分（カプセル）
    const ang = batAngle();
    const gx = BAT.cx + Math.cos(ang) * (BAT.R - 32);
    const gy = BAT.cy + Math.sin(ang) * (BAT.R - 32);
    const hx = BAT.cx + Math.cos(ang) * (BAT.R + 78);
    const hy = BAT.cy + Math.sin(ang) * (BAT.R + 78);
    return {gx,gy,hx,hy,ang};
  }
  function pointSegDist(px,py, ax,ay, bx,by){
    const vx=bx-ax, vy=by-ay;
    const wx=px-ax, wy=py-ay;
    const c1 = vx*wx + vy*wy;
    if (c1<=0) return Math.hypot(px-ax, py-ay);
    const c2 = vx*vx + vy*vy;
    if (c2<=c1) return Math.hypot(px-bx, py-by);
    const t = c1/c2;
    const projx = ax + t*vx, projy = ay + t*vy;
    return Math.hypot(px-projx, py-projy);
  }

  // ===== 打撃判定＆飛球生成 =====
  function tryHit(){
    if (!pitch || !pitch.alive || BAT.hitLock || BAT.activeDigit===0) return;
    // 合計が10でなければ当たってもヒットしない
    if (BAT.activeDigit + pitch.num !== 10) return;

    // バット（カプセル）と球（円）の当たり
    const {gx,gy,hx,hy,ang} = batSegment();
    const dist = pointSegDist(pitch.x, pitch.y, gx,gy, hx,hy);
    const capR = BAT.headR; // カプセル半径に近い値
    const ballR = 18;
    if (dist <= capR + ballR){
      // 接触：打球へ
      BAT.hitLock = true;

      // バットの接線方向（角速度から）
      const w = Math.abs(BAT.end - BAT.start) / BAT.DUR;   // 角速度（概算）
      const tx = -Math.sin(ang), ty =  Math.cos(ang);      // 接線の向き（前方）
      const batSpeed = w * (BAT.R + 60);                   // 先端スピード概算
      const impact = 380 + batSpeed * 0.55;                // 基本インパクト

      // タイミング（プレート近さ）
      const dPlate = Math.abs(pitch.y - (PLATE_Y - 4));
      let timing = 1.0;
      if (dPlate <= 6) timing = 1.3;
      else if (dPlate <= 16) timing = 1.1;
      else if (dPlate <= 28) timing = 0.95;
      else timing = 0.7;

      // 打ち出し速度
      let vx = tx * impact * timing;
      let vy = ty * impact * timing * -0.55; // 画面上方向へ（yは下が+）
      // 少し左右ブレ
      vx += (Math.random()*60 - 30);

      // 種別判定（速度と角度）
      const V = Math.hypot(vx, vy);
      const elevDeg = Math.atan2(-vy, vx) * 180/Math.PI; // 上向きが正
      let type='single';
      if (V < 520 || elevDeg < -10) type='grounder';
      else if (V < 760 || elevDeg < 10) type='single';
      else if (V < 980 || elevDeg < 28) type='double';
      else if (V < 1180 || elevDeg < 40) type='triple';
      else type='homerun';

      // 飛球開始
      fly = {
        x: pitch.x, y: pitch.y,
        vx, vy,
        ax: 0, ay: 880,  // 重力弱め（演出）
        type, t: 0, trail:[]
      };
      pitch.alive = false; // この投球は終了
      endPitch(false);     // 自動判定はしない
      if (type==='grounder') toast('内野ゴロ…');
      if (type==='single')  toast('ヒット！');
      if (type==='double')  toast('ツーベース！');
      if (type==='triple')  toast('スリーベース！');
      if (type==='homerun') toast('ホームラン！');
    }
  }

  function resolveFlyEnd(){
    if (!fly) return;
    const t = fly.type;
    if (t==='grounder'){ out(); }
    else if (t==='single'){ single(); }
    else if (t==='double'){ doubleHit(); }
    else if (t==='triple'){ tripleHit(); }
    else if (t==='homerun'){ homerun(); }
    fly = null;
    updateHUD();
  }

  // ===== 入力（スイング） =====
  function startSwing(n){
    if (BAT.cd<=0){ BAT.t = BAT.DUR; BAT.cd = BAT.COOLDOWN; }
    BAT.activeDigit = n|0;
  }
  pad.addEventListener('click', (e)=>{
    const b = e.target.closest('.num'); if (!b) return;
    startSwing(+(b.dataset.n||0));
  });
  addEventListener('keydown', (e)=>{
    const k = e.key;
    if (k>='1' && k<='9'){ startSwing(+k); }
  });

  // ===== help & reset =====
  function openHelp(){ helpModal.setAttribute('open',''); }
  function closeHelpModal(){ helpModal.removeAttribute('open'); }
  helpBtn.addEventListener('click', openHelp);
  closeHelp.addEventListener('click', closeHelpModal);
  okHelp.addEventListener('click', closeHelpModal);
  helpModal.addEventListener('click', (e)=>{ if (e.target===helpModal) closeHelpModal(); });
  if (!localStorage.getItem('tenbase_seen_help_v2')){ openHelp(); localStorage.setItem('tenbase_seen_help_v2','1'); }
  resetBtn.addEventListener('click', ()=>{ resetGame(); toast('リセットしました'); });

  // ===== 描画 =====
  function drawBall(x,y,r,num){
    ctx.save(); ctx.translate(x,y);
    const g = ctx.createRadialGradient(-r*0.4,-r*0.6, r*0.2, 0,0, r);
    g.addColorStop(0,'#fff'); g.addColorStop(1,'#ececec');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.08)'; ctx.lineWidth=2; ctx.stroke();
    // 縫い目
    ctx.strokeStyle='#d33'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,0,r*0.72, -1.1, 1.1); ctx.stroke();
    ctx.beginPath(); ctx.arc(0,0,r*0.72, Math.PI-1.1, Math.PI+1.1); ctx.stroke();
    // ステッチ
    function stitches(a0,a1){
      const n=6;
      for(let i=0;i<=n;i++){
        const t=i/n, ang=a0+(a1-a0)*t;
        const px=Math.cos(ang)*r*0.72, py=Math.sin(ang)*r*0.72;
        const nx=-Math.sin(ang), ny=Math.cos(ang);
        ctx.beginPath(); ctx.moveTo(px-nx*4, py-ny*4); ctx.lineTo(px+nx*4, py+ny*4); ctx.stroke();
      }
    }
    stitches(-1.1,1.1); stitches(Math.PI-1.1, Math.PI+1.1);
    // 数字
    ctx.fillStyle='#111'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font='bold '+Math.floor(r*1.1)+'px system-ui'; ctx.fillText(num, 0, 2);
    ctx.restore();
  }

  function drawDiamondHUD(){
    const x = 30, y = 28, a = 8;
    function base(px,py,filled){
      ctx.save(); ctx.translate(px,py); ctx.rotate(Math.PI/4);
      ctx.fillStyle = filled ? 'rgba(17,163,111,0.9)' : 'rgba(0,0,0,0.08)';
      ctx.strokeStyle='rgba(0,0,0,0.18)'; ctx.lineWidth=1.3;
      ctx.beginPath(); ctx.rect(-a,-a,a*2,a*2); ctx.fill(); ctx.stroke();
      ctx.restore();
    }
    base(x, y, bases.second);
    base(x-18, y+18, bases.first);
    base(x+18, y+18, bases.third);
    // ホーム
    ctx.save(); ctx.translate(x, y+36); ctx.rotate(Math.PI/4);
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.beginPath(); ctx.rect(-a,-a,a*2,a*2); ctx.fill();
    ctx.restore();
  }

  function drawBat(){
    const {gx,gy,hx,hy,ang} = batSegment();

    // 影（奥）
    ctx.save();
    ctx.globalAlpha = 0.12;
    ctx.lineCap='round';
    ctx.strokeStyle='#000'; ctx.lineWidth = BAT.headR*2.0;
    ctx.beginPath(); ctx.moveTo(gx,gy); ctx.lineTo(hx,hy); ctx.stroke();
    ctx.globalAlpha=1; ctx.restore();

    // バット本体（カプセル：シャフト→ヘッド）
    ctx.save();
    ctx.lineCap='round';
    // シャフト
    ctx.strokeStyle='#c9a36a'; ctx.lineWidth=BAT.shaftR*2;
    ctx.beginPath(); ctx.moveTo(gx,gy); ctx.lineTo(hx,hy-0.0001); ctx.stroke();
    // ヘッド（先端太）
    ctx.strokeStyle='#b88d4d'; ctx.lineWidth=BAT.headR*2;
    const midx = (gx*0.2 + hx*0.8), midy = (gy*0.2 + hy*0.8);
    ctx.beginPath(); ctx.moveTo(midx,midy); ctx.lineTo(hx,hy); ctx.stroke();

    // スイング軌跡（モーションブラー）
    if (BAT.t>0){
      const sweep = 18;
      ctx.globalAlpha=0.22;
      for (let i=1;i<=3;i++){
        const a = ang - i*0.06;
        const gxx = BAT.cx + Math.cos(a) * (BAT.R - 32);
        const gyy = BAT.cy + Math.sin(a) * (BAT.R - 32);
        const hxx = BAT.cx + Math.cos(a) * (BAT.R + 78);
        const hyy = BAT.cy + Math.sin(a) * (BAT.R + 78);
        ctx.lineCap='round';
        ctx.strokeStyle='#b88d4d'; ctx.lineWidth=BAT.headR*2 - i*4;
        ctx.beginPath(); ctx.moveTo(gxx,gyy); ctx.lineTo(hxx,hyy); ctx.stroke();
      }
      ctx.globalAlpha=1;
    }
    ctx.restore();

    // ヒント：狙い（10-投球数字）
    if (pitch){
      ctx.fillStyle='rgba(0,0,0,.62)'; ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.font='bold 14px system-ui';
      ctx.fillText('ねらい： '+(10 - pitch.num), BAT.cx, BAT.cy + BAT.R + 12);
    }
  }

  function drawFly(){
    if (!fly) return;
    // トレイル
    fly.trail.push({x:fly.x, y:fly.y});
    if (fly.trail.length>18) fly.trail.shift();
    ctx.save(); ctx.globalAlpha=0.18;
    ctx.strokeStyle='rgba(0,0,0,.5)'; ctx.lineWidth=2;
    ctx.beginPath();
    for (let i=0;i<fly.trail.length;i++){
      const p = fly.trail[i];
      if (i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);
    }
    ctx.stroke(); ctx.restore();

    // 本体
    const r = 18;
    drawBall(fly.x, fly.y, r, 0);

    // 演出テキスト
    ctx.save();
    ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.font='bold 16px system-ui';
    ctx.fillStyle = (fly.type==='homerun') ? '#e05c80' :
                    (fly.type==='triple') ? '#7a66d9' :
                    (fly.type==='double') ? '#2a8fbd' :
                    (fly.type==='single') ? '#11a36f' : '#6d7280';
    const label = fly.type==='homerun'?'HOMERUN!':
                  fly.type==='triple'?'TRIPLE!':
                  fly.type==='double'?'DOUBLE!':
                  fly.type==='single'?'HIT!':'GROUNDER';
    ctx.fillText(label, fly.x, fly.y - 22);
    ctx.restore();

    // HRのときは花火
    if (fly.type==='homerun' && (Math.random()<0.3)){
      const rr = 6 + Math.random()*16;
      ctx.save(); ctx.globalAlpha=0.6;
      ctx.strokeStyle='#e05c80'; ctx.lineWidth=3;
      ctx.beginPath();
      ctx.arc(fly.x, fly.y, rr, 0, Math.PI*2);
      ctx.stroke(); ctx.restore();
    }
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    // 外枠
    ctx.strokeStyle = 'rgba(0,0,0,.12)'; ctx.lineWidth = 2;
    roundRectPath(LEFT-8, 6, RIGHT-LEFT+16, FLOOR-6, 16); ctx.stroke();

    // フィールド
    ctx.fillStyle='#f9f7f2';
    ctx.fillRect(LEFT, CEIL, RIGHT-LEFT, FLOOR-CEIL);

    // ストライクゾーン
    ctx.save();
    ctx.strokeStyle='rgba(21,84,246,.28)'; ctx.lineWidth=2;
    ctx.strokeRect(PLATE_X-STRIKE_W/2, PLATE_Y-STRIKE_H, STRIKE_W, STRIKE_H);
    ctx.restore();

    // ホームベース
    ctx.fillStyle='#eee';
    ctx.beginPath();
    ctx.moveTo(PLATE_X-16, PLATE_Y+16);
    ctx.lineTo(PLATE_X+16, PLATE_Y+16);
    ctx.lineTo(PLATE_X+16, PLATE_Y);
    ctx.lineTo(PLATE_X, PLATE_Y-16);
    ctx.lineTo(PLATE_X-16, PLATE_Y);
    ctx.closePath(); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,.08)'; ctx.stroke();

    // 現在の投球
    if (pitch){
      drawBall(pitch.x, pitch.y, 18, pitch.num);
    }

    // 飛球
    drawFly();

    // バット
    drawBat();

    // ランナー表示
    drawDiamondHUD();
  }

  function roundRectPath(x,y,w,h,r){
    ctx.beginPath(); ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
  }

  // ===== メインループ =====
  let last = performance.now();
  function loop(now){
    const dt = (now-last)/1000; last=now;

    // バット
    if (BAT.t>0) BAT.t = Math.max(0, BAT.t - dt);
    if (BAT.cd>0) BAT.cd = Math.max(0, BAT.cd - dt);

    // 投球管理
    if (!pitch && !fly){
      nextPitchTimer -= dt;
      if (nextPitchTimer<=0) spawnPitch();
    }

    // 進行：投球
    if (pitch){
      pitch.x += pitch.vx*dt;
      pitch.y += pitch.vy*dt;

      // スイング中は当たり判定
      if (BAT.t>0) tryHit();

      // 通過で自動判定（当たらなかった）
      if (pitch.y >= PLATE_Y + 26){
        endPitch(true);
      }
    }

    // 進行：飛球
    if (fly){
      fly.t += dt;
      // パラメータ差で演出
      if (fly.type==='grounder'){
        // 地面に当たったらすぐ終わり
        fly.vy += 600*dt; fly.x += fly.vx*dt; fly.y += fly.vy*dt;
        if (fly.y >= FLOOR-18){ resolveFlyEnd(); }
      }else if (fly.type==='single'){
        fly.vy += fly.ay*dt; fly.x += fly.vx*dt; fly.y += fly.vy*dt;
        if (fly.y >= PLATE_Y-30 || fly.t>1.2){ resolveFlyEnd(); }
      }else if (fly.type==='double'){
        fly.vy += fly.ay*dt; fly.x += fly.vx*dt; fly.y += fly.vy*dt;
        if (fly.t>1.5 || fly.y >= CEIL+190){ resolveFlyEnd(); }
      }else if (fly.type==='triple'){
        fly.vy += fly.ay*dt; fly.x += fly.vx*dt; fly.y += fly.vy*dt;
        if (fly.t>1.8 || fly.y <= CEIL+40){ resolveFlyEnd(); }
      }else if (fly.type==='homerun'){
        fly.vy += (fly.ay*0.9)*dt; fly.x += fly.vx*dt; fly.y += fly.vy*dt;
        if (fly.y < -40 || fly.t>2.2){ resolveFlyEnd(); }
      }
    }

    draw();
    requestAnimationFrame(loop);
  }

  // init
  resetGame(); updateHUD(); requestAnimationFrame(loop);

})();
</script>

<!-- Service Worker（オフライン対応・動的生成） -->
<script>
if ('serviceWorker' in navigator) {
  const code = `
    const CACHE='10baseball-normal-v2';
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('activate',e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE&&caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch',e=>{
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
    });
  `;
  const blob = new Blob([code], {type:'application/javascript'});
  const url = URL.createObjectURL(blob);
  addEventListener('load', () => navigator.serviceWorker.register(url));
}
</script>
</body>
</html>
