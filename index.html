<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no">
<title>ğŸ‰ Fruit Merge (PWA, 1-file)</title>
<meta name="theme-color" content="#fffbf3">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- ã‚·ãƒ³ãƒ—ãƒ«ç™½PNG(1x1) ã‚¢ã‚¤ã‚³ãƒ³ï¼šå¿…è¦ã«å¿œã˜å·®ã—æ›¿ãˆOK -->
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAukB9Wj1nZkAAAAASUVORK5CYII=">

<!-- Manifest ã‚’ inlinedï¼ˆiOSã§ã¯ãªãAndroidç³»å‘ã‘ã ãŒå¿µã®ãŸã‚ï¼‰ -->
<script type="application/manifest+json">
{
  "name": "Fruit Merge",
  "short_name": "FruitMerge",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#fffbf3",
  "theme_color": "#fffbf3",
  "icons": [
    {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAukB9Wj1nZkAAAAASUVORK5CYII=", "sizes":"192x192","type":"image/png"}
  ]
}
</script>

<style>
  :root{
    --bg1:#fffbf3; --bg2:#fff0d7; --ink:#2a2a33; --ink2:#60606b;
    --chip:#ffffff; --line:#e9e2d6; --accent:#ff6b6b; --accent2:#00b894;
  }
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans","Helvetica Neue",Arial,sans-serif;}
  #wrap{display:flex;flex-direction:column;height:100%;}
  header{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .row{display:flex;align-items:center;gap:8px}
  .title{font-weight:800;letter-spacing:.02em}
  .btn{border:none;border-radius:12px;padding:8px 12px;background:#222;color:#fff;font-weight:700}
  .btn.ghost{background:#fff;color:#222;border:1px solid var(--line)}
  .chip{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
  #stage{flex:1;display:flex;align-items:center;justify-content:center}
  canvas{touch-action:none;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 30px rgba(0,0,0,.08)}
  footer{padding:8px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .hint{color:var(--ink2)}
  .badge{background:#111;color:#fff;border-radius:10px;padding:4px 8px}
  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
         background:#111;color:#fff;border-radius:10px;padding:10px 14px;opacity:0;transition:.25s;pointer-events:none}
  .toast.show{opacity:1}
  /* help */
  #help{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:18px}
  #help .card{max-width:520px;background:#fff;border-radius:16px;padding:18px;border:1px solid var(--line);color:#222}
  #help h3{margin:.2em 0 .4em 0}
  #help li{margin:.25em 0}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="row">
      <div class="title">ğŸ‰ Fruit Merge</div>
      <div id="ver" class="chip">PWA one-file v2</div>
    </div>
    <div class="row">
      <div class="chip">Score: <b id="score">0</b> / Best: <b id="best">0</b></div>
      <div class="chip">Next: <b id="nextName">-</b></div>
      <button id="helpBtn" class="btn ghost">éŠã³æ–¹</button>
      <button id="resetBtn" class="btn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </header>

  <div id="stage">
    <canvas id="cv" width="360" height="640" aria-label="Fruit Merge game canvas"></canvas>
  </div>

  <footer>
    <div class="hint">æŒ‡ã‚’å·¦å³ã«ã‚¹ãƒ©ã‚¤ãƒ‰ â†’ ç‹™ã£ãŸä½ç½®ã§<span class="badge">ã‚¿ãƒƒãƒ—</span>ã§ãƒ•ãƒ«ãƒ¼ãƒ„æŠ•ä¸‹</div>
    <div class="hint">ä¸Šã«çªãæŠœã‘ãŸã‚‰<strong>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</strong>ã€‚åŒã˜ãƒ•ãƒ«ãƒ¼ãƒ„ãŒãã£ã¤ãã¨<span style="color:var(--accent)">é€²åŒ–</span>ï¼</div>
  </footer>
</div>

<div id="help">
  <div class="card">
    <h3>ğŸ® éŠã³æ–¹</h3>
    <ol>
      <li>ç”»é¢ã‚’å·¦å³ã«ã‚¹ãƒ¯ã‚¤ãƒ—ã™ã‚‹ã¨ã€Œç…§æº–ï¼ˆç™½ã„ä¸¸ï¼‰ã€ãŒå‹•ãã¾ã™ã€‚</li>
      <li>ç‹™ã£ãŸä½ç½®ã§ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãƒ•ãƒ«ãƒ¼ãƒ„ãŒè½ã¡ã¾ã™ã€‚</li>
      <li>åŒã˜ç¨®é¡ãŒ<strong>è§¦ã‚Œåˆã†</strong>ï¼‹<strong>ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒé…ã„</strong>ã¨åˆä½“ã—ã¦ä¸€æ®µéšé€²åŒ–ã€‚</li>
      <li>å¤§ãããªã‚‹ã»ã©ç‚¹ãŒé«˜ã„ï¼é€£ç¶šã§é€²åŒ–ã•ã›ã‚‹ã¨ã‚³ãƒ³ãƒœãŒèµ·ãã‚„ã™ã„ã€‚</li>
      <li>ãƒ•ãƒ«ãƒ¼ãƒ„ãŒä¸Šã®èµ¤ç·šã‚’è¶ŠãˆãŸçŠ¶æ…‹ãŒç¶šãã¨<strong>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</strong>ã€‚</li>
    </ol>
    <p class="hint">ãƒ’ãƒ³ãƒˆï¼šå·¦å³ã®å£ã‚„ä»–ã®ãƒ•ãƒ«ãƒ¼ãƒ„ã§<b>ãƒã‚¦ãƒ³ãƒ‰</b>ã—ã¾ã™ã€‚è§’åº¦ã‚’ã¤ã‘ã¦ç€åœ°ã•ã›ã‚‹ã¨å®‰å®šã—ã¦ç©ã‚ã¾ã™ã€‚</p>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="closeHelp" class="btn">OK</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(() => {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const nextNameEl = document.getElementById('nextName');
  const resetBtn = document.getElementById('resetBtn');
  const helpBtn = document.getElementById('helpBtn');
  const helpModal = document.getElementById('help');
  const closeHelp = document.getElementById('closeHelp');
  const toastEl = document.getElementById('toast');

  // ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ Canvas ã‚¹ã‚±ãƒ¼ãƒ«
  function fit(){
    const pad = 16;
    const w = Math.min(innerWidth - pad*2, 420);
    const ratio = w / cv.width;
    cv.style.width = w + 'px';
    cv.style.height = (cv.height * ratio) + 'px';
  }
  addEventListener('resize', fit); fit();

  // ç‰©ç†ï¼†ã‚²ãƒ¼ãƒ å®šæ•°
  const W = cv.width, H = cv.height;
  const LEFT = 20, RIGHT = W-20, FLOOR = H-12, CEIL = 80; // CEIL: èµ¤ã„ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ³
  const G = 1400;             // é‡åŠ›(px/s^2)
  const DT = 1/60;            // ç‰©ç†ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—
  const REST = 0.02;          // åç™ºä¿‚æ•°(ä½ã„ã»ã©å¼¾ã¾ãªã„)
  const FRICTION = 0.995;     // æ‘©æ“¦
  const MAX_BALLS = 70;

  let score = 0, over = false, cooldown = 0, timeTopDanger = 0;
  let aimX = (LEFT+RIGHT)/2;

  // ãƒ•ãƒ«ãƒ¼ãƒ„å®šç¾©ï¼ˆå°â†’å¤§ï¼‰
  const FRUITS = [
    {name:'ãƒã‚§ãƒªãƒ¼', r:14, color:'#ff7ea8'},
    {name:'ã¶ã©ã†',   r:18, color:'#a37bff'},
    {name:'ã™ã‚‚ã‚‚',   r:22, color:'#ff8dd1'},
    {name:'ãƒ¬ãƒ¢ãƒ³',   r:28, color:'#ffe066'},
    {name:'ã¿ã‹ã‚“',   r:36, color:'#ffb347'},
    {name:'ã‚Šã‚“ã”',   r:46, color:'#ff6b6b'},
    {name:'ãƒ©ãƒ»ãƒ•ãƒ©ãƒ³ã‚¹', r:58, color:'#8bd86b'},
    {name:'ãƒ¡ãƒ­ãƒ³',   r:74, color:'#4ad9a3'},
    {name:'ãƒ‘ã‚¤ãƒŠãƒƒãƒ—ãƒ«', r:92, color:'#ffdd57'},
    {name:'ã‚¹ã‚¤ã‚«',   r:116,color:'#22c55e'}
  ];
  let nextLevel = randNextLevel();

  // çŠ¶æ…‹
  /** @type {{x:number,y:number,vx:number,vy:number,r:number,lv:number,mergeLock:number}[]} */
  let balls = [];
  let rings = []; // æ¼”å‡ºç”¨ãƒªãƒ³ã‚°

  function reset(){
    score = 0; over = false; cooldown = 0; timeTopDanger = 0; balls = []; rings=[];
    nextLevel = randNextLevel();
    updateHUD();
  }

  function updateHUD(){
    scoreEl.textContent = score|0;
    const best = +(localStorage.getItem('fruit_merge_best')||0);
    if (score>best) localStorage.setItem('fruit_merge_best', score|0);
    bestEl.textContent = localStorage.getItem('fruit_merge_best') || 0;
    nextNameEl.textContent = FRUITS[nextLevel].name;
  }
  reset();

  function randNextLevel(){
    const r = Math.random();
    if (r<0.55) return 0;
    if (r<0.85) return 1;
    if (r<0.96) return 2;
    return 3;
  }

  function drop(){
    if (over) return;
    if (cooldown>0) return;
    if (balls.length>=MAX_BALLS){ toast("ã„ã£ã±ã„ã§ã™ã€‚åˆä½“ã§æ¸›ã‚‰ãã†ï¼"); return; }
    const f = FRUITS[nextLevel];
    const x = clamp(aimX, LEFT+f.r+1, RIGHT-f.r-1);
    const b = {x, y: CEIL-30, vx:0, vy:0, r:f.r, lv:nextLevel, mergeLock:0};
    balls.push(b);
    cooldown = .25; // æ¬¡ã®æŠ•å…¥ã¾ã§å°‘ã—å¾…ã¤
    nextLevel = randNextLevel();
    updateHUD();
  }

  // ã‚¿ãƒƒãƒ/ãƒã‚¦ã‚¹
  function canvasX(e){
    const rect = cv.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    return (clientX - rect.left) * (cv.width / rect.width);
  }
  cv.addEventListener('touchstart', e=>{ aimX = canvasX(e); drop(); e.preventDefault(); }, {passive:false});
  cv.addEventListener('touchmove', e=>{ aimX = canvasX(e); e.preventDefault(); }, {passive:false});
  cv.addEventListener('mousedown', e=>{ aimX = canvasX(e); drop(); });

  resetBtn.addEventListener('click', reset);
  helpBtn.addEventListener('click', ()=> helpModal.style.display='flex');
  closeHelp.addEventListener('click', ()=> helpModal.style.display='none');

  function clamp(v,min,max){ return v<min?min:(v>max?max:v); }

  // ====== ç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ======
  function step(dt){
    cooldown = Math.max(0,cooldown-dt);

    // é‡åŠ›
    for(const b of balls){
      b.vy += G*dt;
      b.vx *= FRICTION; b.vy *= FRICTION;
      b.x  += b.vx*dt;  b.y  += b.vy*dt;

      // å£
      if (b.x - b.r < LEFT){ b.x = LEFT + b.r; b.vx = -b.vx*(1-REST); }
      if (b.x + b.r > RIGHT){ b.x = RIGHT - b.r; b.vx = -b.vx*(1-REST); }
      // åºŠ
      if (b.y + b.r > FLOOR){
        b.y = FLOOR - b.r;
        if (Math.abs(b.vy) < 40) b.vy = 0; else b.vy = -b.vy*(1-REST);
      }
      // å¤©äº•ï¼ˆä¸Šã®èµ¤ã„ç·šã‚ˆã‚Šä¸Šã«å‡ºãŸã¾ã¾ãªã‚‰å±é™ºã‚«ã‚¦ãƒ³ãƒˆï¼‰
      if (b.y - b.r < 0) timeTopDanger += dt;
    }

    // çƒåŒå£«ã®è¡çªè§£æ¶ˆï¼ˆç©ã¿ã‚„ã™ã„ã‚ˆã†ã«éå¼¾æ€§ï¼‰
    for(let i=0;i<balls.length;i++){
      for(let j=i+1;j<balls.length;j++){
        const A = balls[i], B = balls[j];
        const dx = B.x - A.x, dy = B.y - A.y;
        const dist = Math.hypot(dx,dy);
        const minDist = A.r + B.r;
        if (dist>0 && dist<minDist){
          const overlap = (minDist - dist);
          const nx = dx/dist, ny = dy/dist;
          // 2ã¤ã‚’åŠåˆ†ãšã¤æŠ¼ã—åˆ†ã‘
          A.x -= nx*overlap*0.5; A.y -= ny*overlap*0.5;
          B.x += nx*overlap*0.5; B.y += ny*overlap*0.5;
          // é€Ÿåº¦ã‚’æ³•ç·šæ–¹å‘ã«å¼±ãåç™º
          const rvx = B.vx - A.vx, rvy = B.vy - A.vy;
          const vn = rvx*nx + rvy*ny;
          const imp = -vn*0.5;
          A.vx -= imp*nx; A.vy -= imp*ny;
          B.vx += imp*nx; B.vy += imp*ny;
        }
      }
    }

    // åˆä½“ï¼ˆåŒãƒ¬ãƒ™ãƒ« & æ¥è§¦ & ç›¸å¯¾é€Ÿåº¦ãŒå°ã•ã„ï¼‰
    const toRemove = new Set(); let merged = false;
    for(let i=0;i<balls.length;i++){
      const A = balls[i];
      if(toRemove.has(i) || A.mergeLock>0) continue;
      for(let j=i+1;j<balls.length;j++){
        const B = balls[j];
        if(toRemove.has(j)||B.mergeLock>0) continue;
        if(A.lv!==B.lv) continue;
        const dx=B.x-A.x, dy=B.y-A.y, dist=Math.hypot(dx,dy);
        if(dist < A.r+B.r - 2){
          const rel = Math.hypot(B.vx-A.vx, B.vy-A.vy);
          if (rel < 80){ // ã‚†ã£ãã‚Šãªã‚‰åˆä½“
            const lv = Math.min(A.lv+1, FRUITS.length-1);
            const f = FRUITS[lv];
            const nx = (A.x + B.x)/2, ny = (A.y + B.y)/2;
            balls.push({x:nx,y:ny,vx:(A.vx+B.vx)/2,vy:(A.vy+B.vy)/2,r:f.r,lv,mergeLock:0});
            rings.push({x:nx,y:ny,r: f.r*0.6, t:0, col:f.color});
            toRemove.add(i); toRemove.add(j);
            score += Math.pow(2, lv+1) * 5;
            merged = true;
            break;
          }
        }
      }
    }
    if(merged){
      // ä¸€ç¬ã¯å†åˆä½“ã—ãªã„ãƒ­ãƒƒã‚¯
      balls.forEach(b=>b.mergeLock=Math.max(0,b.mergeLock-1));
    }
    // å‰Šé™¤
    if(toRemove.size){
      balls = balls.filter((_,idx)=>!toRemove.has(idx));
    }
    balls.forEach(b=>{ if(b.mergeLock>0) b.mergeLock--; });

    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®šï¼šä¸Šç«¯ã‹ã‚‰å‡ºãŸçŠ¶æ…‹ãŒç¶šã
    if (timeTopDanger > 1.2 && !over){ over=true; toast("GAME OVER! ãƒªã‚»ãƒƒãƒˆã§å†æŒ‘æˆ¦"); }
    if (!balls.some(b=>b.y-b.r<0)) timeTopDanger = 0;
  }

  // ====== æç”» ======
  function draw(){
    ctx.clearRect(0,0,W,H);

    // ãƒãƒƒã‚¯ï¼ˆæ·¡è‰²ï¼‰
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,W,H);

    // æ 
    ctx.strokeStyle = '#e9e2d6'; ctx.lineWidth = 2;
    roundRect(ctx, LEFT-6, 6, RIGHT-LEFT+12, FLOOR-6, 14); ctx.stroke();

    // å±é™ºãƒ©ã‚¤ãƒ³
    ctx.strokeStyle = '#ff5a5a'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(LEFT, CEIL); ctx.lineTo(RIGHT, CEIL); ctx.stroke();

    // ç…§æº–
    const fN = FRUITS[nextLevel];
    const ax = clamp(aimX, LEFT+fN.r+1, RIGHT-fN.r-1);
    ctx.globalAlpha = 0.25;
    drawFruit(ax, CEIL-30, fN.r, nextLevel);
    ctx.globalAlpha = 1;

    // ãƒ•ãƒ«ãƒ¼ãƒ„
    for(const b of balls){ drawFruit(b.x,b.y,b.r,b.lv); }

    // åˆä½“ãƒªãƒ³ã‚°
    for(const r of rings){
      r.t += 1/60;
      ctx.globalAlpha = Math.max(0, 1-r.t);
      ctx.strokeStyle = r.col; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.arc(r.x,r.y, r.r + r.t*28, 0, Math.PI*2); ctx.stroke();
      ctx.globalAlpha = 1;
    }
    rings = rings.filter(r=>r.t<1);

    // Overè¡¨ç¤º
    if (over){
      ctx.fillStyle = 'rgba(0,0,0,.45)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle = '#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font = 'bold 36px system-ui'; ctx.fillText('GAME OVER', W/2, H*0.42);
      ctx.font = '16px system-ui'; ctx.fillText('ãƒªã‚»ãƒƒãƒˆã§å†æŒ‘æˆ¦', W/2, H*0.56);
    }
  }

  function drawFruit(x,y,r,lv){
    const col = FRUITS[lv].color;
    // æœ¬ä½“
    const grad = ctx.createRadialGradient(x-r*0.5,y-r*0.5,r*0.3, x,y,r);
    grad.addColorStop(0,'#fff'); grad.addColorStop(1,col);
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    // è¼ªéƒ­
    ctx.strokeStyle = 'rgba(0,0,0,.08)'; ctx.lineWidth=2; ctx.stroke();
    // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    ctx.beginPath(); ctx.arc(x-r*0.4,y-r*0.4, r*0.35, 0, Math.PI*2);
    ctx.strokeStyle='rgba(255,255,255,.5)'; ctx.lineWidth=2; ctx.stroke();
  }

  function roundRect(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y);
    c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r);
    c.arcTo(x,y,x+w,y,r); c.closePath(); }

  // ====== ãƒ«ãƒ¼ãƒ— ======
  let acc = 0, last = performance.now();
  function loop(now){
    const dt = (now-last)/1000; last = now; acc += dt;
    while(acc>DT){ step(DT); acc-=DT; }
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 1500);
  }
})();
</script>

<!-- ====== Service Worker ã‚’ãã®å ´ã§ç”Ÿæˆãƒ»ç™»éŒ²ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒ–ï¼‰ ====== -->
<script>
if ('serviceWorker' in navigator) {
  const code = `
    const CACHE='fruit-merge-onefile-v2';
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('activate',e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE&&caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch',e=>{
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
    });
  `;
  const blob = new Blob([code], {type:'application/javascript'});
  const url = URL.createObjectURL(blob);
  addEventListener('load', ()=> navigator.serviceWorker.register(url));
}
</script>
</body>
</html>
