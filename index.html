<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>10 Game â€” DecaMerge v1.2</title>
<meta name="theme-color" content="#F6F3EE">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAukB9Wj1nZkAAAAASUVORK5CYII=">

<!-- Manifest (inlined) -->
<script type="application/manifest+json">
{
  "name": "10 Game â€” DecaMerge",
  "short_name": "10 Game",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#F6F3EE",
  "theme_color": "#F6F3EE",
  "icons": [
    {"src":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAukB9Wj1nZkAAAAASUVORK5CYII=","sizes":"192x192","type":"image/png"}
  ]
}
</script>

<style>
  :root{
    /* Euro minimal palette */
    --bg:#F6F3EE; --paper:#FFFFFF; --ink:#1B1B1B; --muted:#6D7280; --line:#E6E0D7; --chip:#FAF8F4;
    --accent:#E24E52; --ok:#12B886;

    /* small 1-9 */
    --n1:#E96B6B; --n2:#F0A27A; --n3:#F3D277; --n4:#90CDBF; --n5:#BDE0FE;
    --n6:#7CB7F3; --n7:#B7A4E8; --n8:#F48BC6; --n9:#D3AE63;

    /* big >=10 */
    --b10:#3BB273; --b20:#2A8FBD; --b40:#8266CC; --b80:#E05C80; --b160:#D9922B;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0; color:var(--ink);
    background:radial-gradient(1200px 600px at 50% -10%,#FFF,#F6F3EE 55%);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Helvetica Neue","Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
  }
  #wrap{min-height:100%;display:flex;flex-direction:column}

  header{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--line)}
  .brand{display:flex;align-items:baseline;gap:10px}
  .ttl{font-weight:800;letter-spacing:.02em}
  .sub{color:var(--muted);font-size:12px;letter-spacing:.04em}
  .chips{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid var(--line);padding:8px 10px;border-radius:12px}
  .btn{border:1px solid var(--line);padding:8px 12px;border-radius:12px;background:#fff;font-weight:700}
  .btn.strong{border-color:transparent;background:var(--ink);color:#fff}
  .btn.ghost{background:#fff}
  .btn:disabled{opacity:.45}
  .nextBadge{display:flex;align-items:center;gap:8px;background:var(--accent);color:#fff;border-radius:14px;padding:8px 12px;font-weight:800}
  .nextCircle{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.22);display:grid;place-items:center;font-size:18px}
  .pair{opacity:.85;font-size:12px}

  #stage{flex:1;display:flex;align-items:center;justify-content:center;padding:14px}
  canvas{touch-action:none;background:var(--paper);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,.06)}

  footer{padding:10px 14px;border-top:1px solid var(--line);color:var(--muted);font-size:14px;text-align:center}

  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
    background:#111;color:#fff;border-radius:10px;padding:10px 14px;opacity:0;transition:.25s}
  .toast.show{opacity:1}

  /* Help modal */
  #help{position:fixed;inset:0;background:rgba(0,0,0,.38);display:none;align-items:center;justify-content:center;padding:18px}
  #help .card{width:min(560px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}
  #help h3{margin:.2em 0 .6em;font-size:18px}
  #help ol{padding-left:1.1em}
  #help li{margin:.35em 0}
  #help .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="brand">
      <div class="ttl">10 Game</div>
      <div class="sub">DecaMerge â€” è¶³ã—ã¦10â†’10â†’20â†’40â€¦</div>
    </div>
    <div class="chips">
      <div class="chip">Score: <b id="score">0</b> / Best: <b id="best">0</b></div>
      <div class="nextBadge">
        Next <div class="nextCircle" id="nextCircle">-</div>
        <span class="pair">â†’ è£œæ•° <b id="pairNum">-</b></span>
      </div>
      <button class="btn ghost" id="helpBtn">éŠã³æ–¹</button>
      <button class="btn ghost" id="hintBtn">ãƒ’ãƒ³ãƒˆ ON</button>
      <button class="btn ghost" id="undoBtn" disabled>å…ƒã«æˆ»ã™</button>
      <button class="btn strong" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </header>

  <div id="stage">
    <!-- å›ºå®šå†…éƒ¨è§£åƒåº¦ï¼šCSSã§ã‚¹ã‚±ãƒ¼ãƒ« -->
    <canvas id="cv" width="360" height="640" aria-label="10 Game canvas"></canvas>
  </div>

  <footer>
    æŒ‡ã§å·¦å³ã«<strong>ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¦ã­</strong>ã€‚<strong>æŒ‡ã‚’é›¢ã—ãŸã‚‰</strong>ã€ãã®ä½ç½®ã«æŠ•å…¥ï¼ˆã€Œã‚¿ãƒƒãƒ—ã€ã¯ç§»å‹•ãŒå°ã•ã„é›¢ã—åˆ¤å®šï¼‰ã€‚<br>
    <b>è¶³ã—ã¦10</b>ã§ã€Œ10ã€ã«åˆä½“ã€<b>åŒã˜å¤§ç‰</b>ã¯å€ã€…ã«åˆä½“ï¼
  </footer>
</div>

<!-- ãƒ˜ãƒ«ãƒ— -->
<div id="help">
  <div class="card">
    <h3>ğŸ® éŠã³æ–¹ï¼ˆ10 Game - DecaMergeï¼‰</h3>
    <ol>
      <li>ç”»é¢ä¸Šã§æŒ‡ã‚’<strong>å·¦å³ã«ã‚¹ãƒ©ã‚¤ãƒ‰</strong>ã—ã¦ã€è½ã¨ã™ä½ç½®ã‚’æ±ºã‚ã¾ã™ã€‚</li>
      <li>ä½ç½®ãŒæ±ºã¾ã£ãŸã‚‰<strong>æŒ‡ã‚’é›¢ã™</strong>ã¨ã€ç‰ãŒãã®åˆ—ã«è½ã¡ã¾ã™ï¼ˆ<strong>ã‚¹ãƒ©ã‚¤ãƒ‰ä¸­ã¯è½ã¡ã¾ã›ã‚“</strong>ï¼‰ã€‚</li>
      <li><strong>å°ã•ã„æ•°å­—åŒå£«</strong>ãŒè§¦ã‚Œã¦åˆè¨ˆãŒ<strong>10</strong>ã«ãªã‚‹ã¨ã€<strong>ã€Œ10ã€ç‰</strong>ã«å³åˆä½“ï¼</li>
      <li><strong>åŒã˜å¤§ç‰</strong>åŒå£«ã¯åˆä½“ã—ã¦<strong>å€</strong>ã«ãªã‚Šã¾ã™ï¼ˆ10â†’20â†’40â†’80â†’â€¦ï¼‰ã€‚</li>
      <li>ç·‘ã®ã‚´ãƒ¼ã‚¹ãƒˆã¯ã€Œä»Šã®ä½ç½®ã§æŠ•å…¥ã™ã‚‹ã¨ã™ãåˆä½“ã€ã‚’ç¤ºã—ã¾ã™ã€‚</li>
      <li>èª¤æ“ä½œã—ãŸã‚‰<strong>å…ƒã«æˆ»ã™</strong>ã§1æ‰‹æˆ»ã›ã¾ã™ã€‚</li>
    </ol>
    <p style="color:var(--muted);font-size:13px">â€» ãƒ’ãƒ³ãƒˆONã§å„ç‰ã®ä¸Šã«ã€Œ10ã¾ã§ã‚ã¨ã„ãã¤ã€ã‚’è¡¨ç¤ºã€‚æš—ç®—ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«æœ€é©ï¼</p>
    <div class="actions">
      <button class="btn ghost" id="closeHelp">é–‰ã˜ã‚‹</button>
      <button class="btn strong" id="okHelp">OK</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(()=> {
  // ==== DOM ====
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const nextCircle = document.getElementById('nextCircle');
  const pairNumEl = document.getElementById('pairNum');
  const resetBtn = document.getElementById('resetBtn');
  const hintBtn = document.getElementById('hintBtn');
  const undoBtn = document.getElementById('undoBtn');
  const toastEl = document.getElementById('toast');
  const helpBtn = document.getElementById('helpBtn');
  const helpModal = document.getElementById('help');
  const closeHelp = document.getElementById('closeHelp');
  const okHelp = document.getElementById('okHelp');

  // ==== layout fit ====
  function fit(){
    const maxW = Math.min(innerWidth - 24, 440);
    const ratio = maxW / cv.width;
    cv.style.width = maxW+'px';
    cv.style.height = (cv.height*ratio)+'px';
  }
  addEventListener('resize', fit); fit();

  // ==== physics constants (tuned for low bounce) ====
  const W = cv.width, H = cv.height;
  const LEFT = 22, RIGHT = W-22, FLOOR = H-14, CEIL = 80;
  const G = 1280;         // 1500 -> 1280 ã§è·³ã­éãæŠ‘åˆ¶
  const DT = 1/60;
  const FRICTION = 0.992; // æ¸›è¡°å¼·ã‚
  const REST = 0.01;      // åç™ºã»ã¼ç„¡ã—
  const MAX_BALLS = 90;
  const VX_MAX = 900, VY_MAX = 2200;

  // ==== state ====
  /** @type {{x:number,y:number,vx:number,vy:number,r:number,val:number,lock:number,id:number}[]} */
  let balls = [];
  let rings = []; // merge rings
  let score = 0, over = false, cooldown = 0;
  let aimX = (LEFT+RIGHT)/2;
  let next = randSmall();
  let showHint = true;
  let topDanger = 0;
  let idSeq = 1;

  // pointer gesture state
  let dragging = false, startX=0, startY=0, moved=0, downTime=0, activePointer=null;

  // undo
  let undoState = null;

  // ==== helpers ====
  const CSS = (n)=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
  const smallColor = (v)=>CSS('--n'+v);
  function bigColor(v){
    if (v>=160) return CSS('--b160');
    if (v>=80)  return CSS('--b80');
    if (v>=40)  return CSS('--b40');
    if (v>=20)  return CSS('--b20');
    return CSS('--b10');
  }
  function radiusFor(v){
    if (v<10) return 16 + v*1.9; // 1â†’17.9 â€¦ 9â†’33.1
    const raw = 22 + Math.log2(v/10 + 1) * 21; // 10â†’43,20â†’~54,40â†’~65,80â†’~75
    return Math.min(raw, 58);
  }
  function randSmall(){
    const r = Math.random();
    if (r<0.15) return 1;
    if (r<0.30) return 2;
    if (r<0.47) return 3;
    if (r<0.64) return 4;
    if (r<0.78) return 5;
    if (r<0.88) return 6;
    if (r<0.94) return 7;
    if (r<0.98) return 8;
    return 9;
  }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function updateHUD(){
    scoreEl.textContent = score|0;
    const best = +(localStorage.getItem('decamerge_best')||0);
    if (score>best) localStorage.setItem('decamerge_best', score|0);
    bestEl.textContent = localStorage.getItem('decamerge_best')||0;
    nextCircle.textContent = next;
    pairNumEl.textContent = 10-next;
    hintBtn.textContent = showHint ? 'ãƒ’ãƒ³ãƒˆ OFF' : 'ãƒ’ãƒ³ãƒˆ ON';
    undoBtn.disabled = !undoState;
  }

  // ==== pointer inputs (æ»‘ã‚‰ã‹ãªã‚¹ãƒ¯ã‚¤ãƒ— / é›¢ã—ãŸã‚‰ã‚¿ãƒƒãƒ—åˆ¤å®š) ====
  const TAP_DIST = 10;     // px
  const TAP_TIME = 350;    // ms

  function onPointerDown(e){
    if (activePointer !== null) return; // 1æœ¬ã®ã¿
    cv.setPointerCapture(e.pointerId);
    activePointer = e.pointerId;
    dragging = true;
    const x = canvasX(e);
    aimX = clamp(x, LEFT, RIGHT);
    startX = x; startY = e.clientY || 0; moved = 0; downTime = performance.now();
  }
  function onPointerMove(e){
    if (!dragging || e.pointerId !== activePointer) return;
    const x = canvasX(e);
    moved = Math.max(moved, Math.abs(x - startX));
    aimX = clamp(x, LEFT, RIGHT);
  }
  function onPointerUp(e){
    if (e.pointerId !== activePointer) return;
    const elapsed = performance.now() - downTime;
    const wasTap = (moved < TAP_DIST) && (elapsed < TAP_TIME);
    dragging = false; activePointer = null;
    cv.releasePointerCapture(e.pointerId);
    if (wasTap) drop();
  }

  // fallback for touch browsers if PointerEvents disabledï¼ˆiOSã¯å¯¾å¿œæ¸ˆã¿ï¼‰
  if (window.PointerEvent){
    cv.addEventListener('pointerdown', onPointerDown, {passive:false});
    cv.addEventListener('pointermove', onPointerMove, {passive:false});
    cv.addEventListener('pointerup',   onPointerUp,   {passive:false});
    cv.addEventListener('pointercancel', ()=>{ dragging=false; activePointer=null; });
  }

  resetBtn.addEventListener('click', reset);
  hintBtn.addEventListener('click', ()=>{ showHint = !showHint; updateHUD(); });
  undoBtn.addEventListener('click', undo);
  helpBtn.addEventListener('click', ()=> helpModal.style.display='flex');
  closeHelp.addEventListener('click', ()=> helpModal.style.display='none');
  okHelp.addEventListener('click', ()=> helpModal.style.display='none');

  // åˆå›ã¯è‡ªå‹•ã§ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
  if (!localStorage.getItem('decamerge_seen_help')) {
    helpModal.style.display='flex';
    localStorage.setItem('decamerge_seen_help','1');
  }

  // ==== game control ====
  function reset(){
    balls = []; rings = []; score=0; over=false; cooldown=0; topDanger=0; aimX=(LEFT+RIGHT)/2; next=randSmall(); undoState=null;
    updateHUD();
  }
  function snapshot(){
    return {
      balls: balls.map(b=>({x:b.x,y:b.y,vx:b.vx,vy:b.vy,r:b.r,val:b.val,lock:b.lock,id:b.id})),
      rings: rings.map(r=>({...r})),
      score, over, cooldown, topDanger, aimX, next
    };
  }
  function restore(s){
    balls = s.balls.map(b=>({...b}));
    rings = s.rings.map(r=>({...r}));
    score = s.score; over=s.over; cooldown=s.cooldown; topDanger=s.topDanger; aimX=s.aimX; next=s.next;
    updateHUD();
  }
  function undo(){
    if (!undoState) return;
    restore(undoState);
    undoState = null;
    toast('1æ‰‹æˆ»ã—ã¾ã—ãŸ');
  }
  function drop(){
    if (over || cooldown>0) return;
    if (balls.length>=MAX_BALLS){ toast('ã„ã£ã±ã„ã§ã™ã€‚åˆä½“ã§æ¸›ã‚‰ãã†ï¼'); return; }

    // 1æ‰‹ã‚¢ãƒ³ãƒ‰ã‚¥
    undoState = snapshot();

    const val = next;
    const r = radiusFor(val);
    const x = clamp(aimX, LEFT+r+1, RIGHT-r-1);
    // æ–°è¦ç‰ã¯ã€Œå³åˆä½“OKã€=> lockSmall=0
    balls.push({x, y: CEIL-30, vx:0, vy:0, r, val, lock: (val<10? 0 : 10), id:idSeq++});
    score += val; // æŠ•å…¥ãƒœãƒ¼ãƒŠã‚¹
    next = randSmall();
    cooldown = .18; // é€£æ‰“é˜²æ­¢ å°‘ã—çŸ­ã
    updateHUD();
  }

  // ==== physics step ====
  function step(dt){
    cooldown = Math.max(0, cooldown-dt);

    // gravity & move
    for (const b of balls){
      b.vy += G*dt;
      b.vx *= FRICTION; b.vy *= FRICTION;
      // é€Ÿåº¦ã‚¯ãƒ©ãƒ³ãƒ—ï¼ˆè·³ã­ã™ãé˜²æ­¢ï¼‰
      b.vx = clamp(b.vx, -VX_MAX, VX_MAX);
      b.vy = clamp(b.vy, -VY_MAX, VY_MAX);
      b.x  += b.vx*dt;  b.y  += b.vy*dt;

      // walls
      if (b.x - b.r < LEFT){ b.x = LEFT + b.r; b.vx = -b.vx*(1-REST); }
      if (b.x + b.r > RIGHT){ b.x = RIGHT - b.r; b.vx = -b.vx*(1-REST); }
      if (b.y + b.r > FLOOR){
        b.y = FLOOR - b.r;
        if (Math.abs(b.vy) < 30) b.vy = 0; else b.vy = -b.vy*(1-REST); // ã—ãã„å€¤ã‚’ä½ã‚ã«
      }
      if (b.lock>0) b.lock--;
      if (b.y - b.r < 0) topDanger += dt;
    }

    // pairwise collision resolveï¼ˆã‚ˆã‚Šéå¼¾æ€§ï¼‰
    for (let i=0;i<balls.length;i++){
      for (let j=i+1;j<balls.length;j++){
        const A = balls[i], B = balls[j];
        const dx = B.x - A.x, dy = B.y - A.y;
        const dist = Math.hypot(dx,dy);
        const minD = A.r + B.r;
        if (dist>0 && dist < minD){
          const nx = dx/dist, ny = dy/dist;
          const overlap = (minD - dist);
          // separate
          A.x -= nx*overlap*0.5; A.y -= ny*overlap*0.5;
          B.x += nx*overlap*0.5; B.y += ny*overlap*0.5;
          // dampened bounceï¼ˆã•ã‚‰ã«å¼±ãï¼‰
          const rvx = B.vx - A.vx, rvy = B.vy - A.vy;
          const vn = rvx*nx + rvy*ny;
          const imp = -vn*0.3; // 0.6 â†’ 0.3 ã§åç™ºä½æ¸›
          A.vx -= imp*nx; A.vy -= imp*ny; B.vx += imp
